var bloglists;var inputBlogs;var bloglistToBeAdded;var entries;var blogId;var listId;var sent=0;var blog;var tags;var rawTags;var userTags;var noRepeatPress=false;var editingUserTags=false;function init(){$("#editIntrests").tooltip();$("#addlist").tooltip();$("#blogUrl").tooltip();$("#dialogCopySharelink").dialog({autoOpen:false,modal:true,resizable:false,width:500,buttons:{Done:function(){$(this).dialog("close")},},open:function(){$("#sharelink").select()},close:function(){$("#sharelink").val("")}});$("#dialogCopySharelink").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogCopySharelink").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogSelectListAddBlog").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Add blog":function(){listId=$("#listSelection").val();$.post("/listmanager",{action:"addBlog",listId:bloglists[listId].id,blogId:blogId},function(A){sessionStorage.activeList=listId-2;location="/my-blogs"})},Cancel:function(){$(this).dialog("close")}},open:function(){for(var A=2;A<bloglists.length;A++){$("#listSelection").append('<option value="'+A+'">'+bloglists[A].name+"</option>")}},close:function(){}});$("#dialogSelectListAddBlog").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogSelectListAddBlog").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogConfirmBlogDelete").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Delete blog":function(){$.post("/listmanager",{action:"removeBlog",listId:listId,blogId:blogId},function(){location.reload()})},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){}});$("#dialogConfirmBlogDelete").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogConfirmBlogDelete").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogError").dialog({autoOpen:false,modal:true,resizable:false,buttons:{OK:function(){$(this).dialog("close")}},open:function(){},close:function(){}});$("#dialogError").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogError").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogConfirmBloglistAdd").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Add shared bloglist":function(){blogs=bloglistToBeAdded;$("#validateTipsBloglistAdd").html('<img src="img/ajax-loader.gif" alt="loading">');$.post("/listmanager",{action:"addList",listName:blogs.name},function(B){sessionStorage.activeList=bloglists.length-2;sent=0;for(var A=0;A<blogs.list.length;A++){sent++;$.post("/listmanager",{action:"addBlog",listId:B,blogId:blogs.list[A]},function(){sent--;if(sent==0){location="/my-blogs"}})}})},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){}});$("#dialogConfirmBloglistAdd").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogConfirmBloglistAdd").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogConfirmListDelete").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Delete bloglist":function(){$.post("/listmanager",{action:"removeList",listId:listId},function(){location.reload()});sessionStorage.activeList=0},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){}});$("#dialogConfirmListDelete").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogConfirmListDelete").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogEditTags").dialog({autoOpen:false,modal:true,resizable:false,buttons:{Done:function(){$(this).dialog("close")}},open:function(){$(".tagRemove").button()},close:function(){$("#tags").val("");var A=document.getElementById("addMultipleBlogsUL");A.innerHTML=""}});$("#tags").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#addTagButton").trigger("click");return false}});$("#dialogAddMultipleBlogs").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Add blogs":function(){var B=document.getElementById("addMultipleBlogsUL");sent=0;for(var A=0;A<B.children.length;A++){if(B.children[A].children[0].checked){sent++;$.post("/listmanager",{action:"addBlog",listId:listId,blogTitle:inputBlogs[A].title,blogUrl:inputBlogs[A].xmlUrl},function(){sent--;if(sent==0){location.reload()}})}}$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){var A=document.getElementById("addMultipleBlogsUL");A.innerHTML=""}});$("#dialogAddMultipleBlogs").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogAddMultipleBlogs").parent().find("button:eq(0)").trigger("click");return false}});$("#dialogAddBloglist").dialog({autoOpen:false,modal:true,resizable:false,buttons:{"Add list":function(){var A=$("#name");var B=true;A.removeClass("ui-state-error");B=B&&checkLength(A,"bloglist name",2,32);B=B&&checkRegexp(A,/^[a-z]([0-9a-z_ ])+$/i,"Bloglist name may consist of a-z, 0-9, underscores, begin with a letter.");if(B){$.post("/listmanager",{action:"addList",listName:document.getElementById("name").value},function(){sessionStorage.activeList=bloglists.length-2;location.reload()})}},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){var B=$("#name");B.removeClass("ui-state-error");document.getElementById("name").value="";var A=$(".validateTips");A.text("")}});$("#dialogAddBloglist").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogAddBloglist").parent().find("button:eq(0)").trigger("click");return false}});$("#addBlogTabs").tabs({heightStyle:"auto"});$("#dialogAddBlog").dialog({autoOpen:false,modal:true,resizable:false,width:500,buttons:{"Add list":function(){var D=$("#addBlogTabs").tabs("option","active");var A=$("#accordion").accordion("option","active");switch(D){case 0:var B=$("#blogUrl");$(B).parent().parent().prev().html('<img src="img/ajax-loader.gif" alt="loading">');var J=true;B.removeClass("ui-state-error");J=J&&checkLength(B,"blog url",2,200);J=J&&checkRegexp(B,/(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/,"Blog RSS url must be an url.");if(J){sessionStorage.activeList=A;blogUrl=B.val();var H=new google.feeds.Feed(blogUrl);H.setNumEntries(1);H.load(function(L){if(!L.error){var M=L.feed.entries[0].author;$.post("/listmanager",{action:"addBlog",listId:listId,blogTitle:M,blogUrl:blogUrl},function(){location.reload()})}else{B.addClass("ui-state-error");updateTips("Error with given RSS url. Check url and try again.",B)}})}break;case 1:sessionStorage.activeList=A;var K=document.getElementById("googleAccountPassword");$(K).removeClass("ui-state-error");$(K).parent().parent().prev().html('<img src="img/ajax-loader.gif" alt="loading">');var I=encodeURIComponent(K.value);$.post("/gReaderImport",{password:I},function(L){if(L==0){updateTips("Error retrieving google reader subscriptions. Possibly wrong password.",K);$(K).addClass("ui-state-error")}else{updateTips("Subscriptions loaded.",K);var M=createBloglistGreader($.parseJSON(L));if(M==false){updateTips("Error parsing file.",K);$(K).addClass("ui-state-error")}else{inputBlogs=M;for(var N=0;N<M.length;N++){$("#addMultipleBlogsUL").append('<li><input class="blogCheckbox" type="checkbox"> '+M[N].title+"</li>")}$("#dialogAddMultipleBlogs").dialog("open")}}});break;case 2:sessionStorage.activeList=A;var G=document.getElementById("OPML");$(G).removeClass("ui-state-error");$(G).parent().parent().prev().html('<img src="img/ajax-loader.gif" alt="loading">');var C=G.files[0];var E=new FileReader();var F;if(C===undefined){updateTips("Select an input file.",G);break}E.readAsText(C);E.onload=function(){updateTips("",G);F=$.xml2json(E.result);var L=createBloglist(F);if(L==false){updateTips("Error parsing file.",G);$(G).addClass("ui-state-error")}else{inputBlogs=L;for(var M=0;M<L.length;M++){$("#addMultipleBlogsUL").append('<li><input class="blogCheckbox" type="checkbox"> '+L[M].title+"</li>");$("#dialogAddMultipleBlogs").dialog("open")}}};break}},Cancel:function(){$(this).dialog("close")}},open:function(){},close:function(){}});$("#dialogAddBlog").keypress(function(A){if(A.keyCode==$.ui.keyCode.ENTER){$("#dialogAddBlog").parent().find("button:eq(0)").trigger("click");return false}});manageSharing();$.getJSON("/tags",{action:"getAllTags"},function(A){tags=A;rawTags=[];for(var B=0;B<tags.length;B++){rawTags.push(tags[B].name.toLowerCase())}$("#tags").autocomplete({source:rawTags})});$.getJSON("/tags",{action:"getUsersTags"},function(A){userTags=A});$.get("/bloglists",function(B){bloglists=$.parseJSON(B);if(bloglists.length==2&&!isLoggedIn()){$("#accordion").html("Log in to manage your bloglists.");$("#addlist").hide();$("#editIntrests").hide()}else{if(bloglists.length==2&&isLoggedIn()){$("#accordion").html("You currently have no bloglists. Start by creating some.")}else{for(var E=2;E<bloglists.length;E++){$("#accordion").append(createListRow(E,bloglists[E].name));var F=document.createElement("div");var D=document.createElement("ul");F.appendChild(D);for(var C=0;C<bloglists[E].blogs.length;C++){var A=document.createElement("li");A.innerHTML=bloglists[E].blogs[C].title+' <span class="blogButtons"><a class="editTags" href="javascript:void(0)">EDIT TAGS</a><a class="removeBlog" id="blog.'+bloglists[E].blogs[C].id+"."+E+"."+C+'" href="javascript:void(0)">REMOVE BLOG</a></span>';D.appendChild(A)}$("#accordion").append(F)}}}addClickListeners()});$(".add").button();$("#addlist").click(function(){$("#dialogAddBloglist").dialog("open")});$("#editIntrests").click(function(A){$("#editTagsUL").html("");for(var B=0;B<userTags.length;B++){$("#editTagsUL").append("<li>"+decodeURIComponent(userTags[B].name)+' <span id="tagRemove.'+B+'" class="tagRemove">REMOVE</span></li>')}editingUserTags=true;addTagRemoveListener();$("#dialogEditTags").dialog("option","title","Editing your intrests.");$("#dialogEditTags").dialog("open")})}window.onload=init;function updateTips(B,C){var A=$(C).parent().parent().prev();A.text(B).addClass("ui-state-highlight");setTimeout(function(){A.removeClass("ui-state-highlight",1500)},500)}function checkLength(C,D,B,A){if(C.val().length>A||C.val().length<B){C.addClass("ui-state-error");updateTips("Length of "+D+" must be between "+B+" and "+A+".",C);return false}else{return true}}function checkRegexp(B,A,C){if(!(A.test(B.val()))){B.addClass("ui-state-error");updateTips(C,B);return false}else{return true}}function createListRow(C,B){var A=document.createElement("h3");A.id=C;A.innerHTML=B+'<span class="bloglistbuttons"><a class="shareList" href="javascript:void(0)">SHARE LIST</a><a class="addBlog" href="javascript:void(0)">ADD BLOG</a><a class="removeList" href="javascript:void(0)">REMOVE LIST</a></span>';return A}function res(){$("#main").css("position","fixed");$("#main").css("height",$("body").height()-185+"px");if($("body").width()<1150){$("#right").hide()}else{$("#right").show()}}function isLoggedIn(){if($(".login li a").attr("title")==="Sign out"){return true}else{if($(".login li a").attr("title")==="Sign in"){return false}}}function addTagToBlog(A,E){var C="";for(var D=1;D<bloglists.length;D++){for(var B=0;B<bloglists[D].blogs.length;B++){if(bloglists[D].blogs[B].id==E){C=C+D+"."+B+"."+bloglists[D].blogs[B].tags.length;bloglists[D].blogs[B].tags.push(A);return C}}}}function addTagToUser(A){userTags.push(A);return(userTags.length-1)}function addTagRemoveListener(){$(".tagRemove").unbind("click");if(editingUserTags){$(".tagRemove").click(function(A){var D=userTags[A.currentTarget.id.split(".")[1]].id;var C=userTags[A.currentTarget.id.split(".")[1]].name;$.post("/tagmanager",{action:"removeTagFromUser",tagId:D,tagName:C});$(A.currentTarget.parentElement).css("display","none");userTags.splice(A.currentTarget.id.split(".")[1],1);$("#editTagsUL").html("");for(var B=0;B<userTags.length;B++){$("#editTagsUL").append("<li>"+userTags[B].name+' <span id="tagRemove.'+B+'" class="tagRemove">REMOVE</span></li>')}addTagRemoveListener();$(".tagRemove").button()})}else{$(".tagRemove").click(function(A){rawBloglistId=A.currentTarget.id.split(".")[1];rawBlogId=A.currentTarget.id.split(".")[2];rawTagId=A.currentTarget.id.split(".")[3];$.post("/tagmanager",{action:"removeTagFromBlog",tagId:bloglists[rawBloglistId].blogs[rawBlogId].tags[rawTagId].id,tagName:bloglists[rawBloglistId].blogs[rawBlogId].tags[rawTagId].name,blogId:bloglists[rawBloglistId].blogs[rawBlogId].id});$(A.currentTarget.parentElement).css("display","none");bloglists[rawBloglistId].blogs[rawBlogId].tags.splice(rawTagId,1);blog=bloglists[rawBloglistId].blogs[rawBlogId];$("#editTagsUL").html("");for(var B=0;B<blog.tags.length;B++){$("#editTagsUL").append("<li>"+blog.tags[B].name+' <span id="tagRemove.'+rawBloglistId+"."+rawBlogId+"."+B+'" class="tagRemove">REMOVE</span></li>')}addTagRemoveListener();$(".tagRemove").button()})}}function blogHasTag(E,D){for(var C=1;C<bloglists.length;C++){for(var B=0;B<bloglists[C].blogs.length;B++){if(bloglists[C].blogs[B].id==E){for(var A=1;A<bloglists[C].blogs[B].tags.length;A++){if(bloglists[C].blogs[B].tags[A].name.toLowerCase()==D){return true}}return false}}}return false}function userHasTag(B){for(var A=0;A<userTags.length;A++){if(userTags[A].name.toLowerCase()==B){return true}}return false}function addClickListeners(){$(".blogButtons a").button();$(".tags a").button();$("#accordion").accordion({heightStyle:"content",active:parseInt(sessionStorage.activeList)});$(".bloglistbuttons a").button();$("#addTagButton").click(function(A){tagName=$("#tags").attr("value");if(tagName==""){return}else{tagName=encodeURIComponent(tagName.toLowerCase())}tagRawId=$.inArray(tagName,rawTags);if(tagRawId!=-1){tagId=tags[tagRawId].id}else{tagId=-1}if(blogHasTag(blogId,tagName)&&!editingUserTags){return}if(userHasTag(tagName)&&editingUserTags){return}$("#editTagsInfo").html('<img src="img/ajax-loader.gif" alt="loading">');$("#addTagButton").button({disabled:true});if(editingUserTags){$.post("/tagmanager",{action:"addTagToUser",tagId:tagId,tagName:tagName},function(B){if(B!=""){tags.push($.parseJSON('{"id":'+B+',"name":"'+tagName+'"}'));$("#editTagsUL").append("<li>"+decodeURIComponent(tagName)+' <span id="tagRemove.'+addTagToUser(tags[tags.length-1])+'" class="tagRemove">REMOVE</span></li>');$(".tagRemove").button();addTagRemoveListener()}else{$("#editTagsUL").append("<li>"+decodeURIComponent(tagName)+' <span id="tagRemove.'+addTagToUser(tags[tagRawId])+'" class="tagRemove">REMOVE</span></li>');$(".tagRemove").button();addTagRemoveListener()}$("#editTagsInfo").html("");$("#addTagButton").button({disabled:false})})}else{$.post("/tagmanager",{action:"addTagToBlog",tagId:tagId,tagName:tagName,blogId:blogId},function(B){if(B!=""){tags.push($.parseJSON('{"id":'+B+',"name":"'+tagName+'"}'));$("#editTagsUL").append("<li>"+decodeURIComponent(tagName)+' <span id="tagRemove.'+addTagToBlog(tags[tags.length-1],blogId)+'" class="tagRemove">REMOVE</span></li>');$(".tagRemove").button();addTagRemoveListener()}else{$("#editTagsUL").append("<li>"+decodeURIComponent(tagName)+' <span id="tagRemove.'+addTagToBlog(tags[tagRawId],blogId)+'" class="tagRemove">REMOVE</span></li>');$(".tagRemove").button();addTagRemoveListener()}$("#editTagsInfo").html("");$("#addTagButton").button({disabled:false})})}});$(".removeList").click(function(A){listId=bloglists[parseInt(A.currentTarget.parentElement.parentElement.id)].id;$("#dialogConfirmListDelete").dialog("open")});$(".removeBlog").click(function(A){blogId=A.currentTarget.id.split(".")[1];listId=bloglists[parseInt(A.currentTarget.parentElement.parentElement.parentElement.parentElement.previousSibling.id)].id;sessionStorage.activeList=$("#accordion").accordion("option","active");$("#dialogConfirmBlogDelete").dialog("open")});$(".editTags").click(function(A){editingUserTags=false;id=A.currentTarget.parentElement.children[1].id;blogId=id.split(".")[1];bloglistId=id.split(".")[2];blogNativeId=id.split(".")[3];blog=bloglists[bloglistId].blogs[id.split(".")[3]];$("#editTagsUL").html("");for(var B=0;B<blog.tags.length;B++){$("#editTagsUL").append("<li>"+decodeURIComponent(blog.tags[B].name)+' <span id="tagRemove.'+bloglistId+"."+blogNativeId+"."+B+'" class="tagRemove">REMOVE</span></li>')}addTagRemoveListener();$("#dialogEditTags").dialog("option","title","Editing "+blog.title+"-s tags.");$("#dialogEditTags").dialog("open")});$(".addBlog").click(function(A){$("#dialogAddBlog").dialog("open");listId=bloglists[parseInt(A.currentTarget.parentElement.parentElement.id)].id});$(".shareList").click(function(B){list=bloglists[parseInt(B.currentTarget.parentElement.parentElement.id)];if(list.blogs.length>0){var A=new Array();for(var C=0;C<list.blogs.length;C++){A.push(list.blogs[C].id)}var E={};E.name=list.name;E.list=A;var F="http://osblogaggregator.appspot.com/my-blogs?ids=";var D=F+encodeURIComponent(JSON.stringify(E));$("#sharelink").val(D);$("#dialogCopySharelink").dialog("open")}else{$("#validateTipsError").html("Cannot share empty bloglist.");$("#validateTipsError").addClass("ui-state-highlight");setTimeout(function(){$("#validateTipsError").removeClass("ui-state-highlight",1500)},500);$("#dialogError").dialog("open")}});$("#selectAll").click(function(B){var A=false;if(B.currentTarget.checked){A=true}else{A=false}$(".blogCheckbox").attr("checked",A)})}function Blog(B,A){this.title=B;this.xmlUrl=A}function createBloglist(D){if(D.body.outline===undefined){return false}if(D.body.outline.length===undefined){var E=D.body.outline.outline;var B=new Array();for(var C=0;C<E.length;C++){var F=new Blog(E[C].title,E[C].xmlUrl);B.push(F)}return B}else{var B=new Array();for(var C=0;C<D.body.outline.length;C++){if(D.body.outline[C].xmlUrl!==undefined){B.push(new Blog(D.body.outline[C].title,D.body.outline[C].xmlUrl))}else{for(var A=0;A<D.body.outline[C].outline.length;A++){B.push(new Blog(D.body.outline[C].outline[A].title,D.body.outline[C].outline[A].xmlUrl))}}}return B}}function createBloglistGreader(C){if(C.subscriptions===undefined){return false}var A=new Array();for(var B=0;B<C.subscriptions.length;B++){A.push(new Blog(C.subscriptions[B].title,C.subscriptions[B].id.substring(5)))}return A}function manageSharing(){var A=window.location.search.substr(1);var C=A.split("&");var G={};for(var B=0;B<C.length;B++){var E=C[B].split("=");G[E[0]]=E[1]}if((G.ids!=undefined)&&isLoggedIn()){var F;try{F=$.parseJSON(decodeURIComponent(G.ids))}catch(D){F=undefined}if(F!==undefined){bloglistToBeAdded=F;$("#dialogConfirmBloglistAdd").dialog("open");$("#validateTipsBloglistAdd").html("Are you sure you want to add the shared bloglist: "+F.name+" ?")}else{$(".ui-dialog-buttonpane button:contains('Add shared bloglist')").button("disable");$("#dialogConfirmBloglistAdd").dialog("open");$("#validateTipsBloglistAdd").html("URL malformed please check the sharing link.");$("#validateTipsBloglistAdd").addClass("ui-state-highlight");setTimeout(function(){$("#validateTipsBloglistAdd").removeClass("ui-state-highlight",1500)},500)}}else{if((G.action!=undefined)&&G.action=="addBlog"&&isLoggedIn()){if(bloglists!=undefined){blogId=G.blogId;$("#dialogSelectListAddBlog").dialog("open")}else{setTimeout("manageSharing()",200)}}else{if((G.ids!=undefined)&&!isLoggedIn()){$("#accordion").html("Log in to accept the shared bloglist.")}else{if((G.action!=undefined)&&G.action=="addBlog"&&!isLoggedIn()){$("#accordion").html("Log in to add the blog.")}}}}};